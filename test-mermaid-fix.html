<!DOCTYPE html>
<html>
<head>
    <title>Mermaid Test Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.4/dist/mermaid.min.js"></script>
    <style>
        .mermaid {
            background: transparent;
            padding: 10px;
            border: none;
            font-family: monospace;
            text-align: center;
            display: block;
            margin: 10px 0;
        }
        
        .mermaid:not([data-processed]) {
            background: #f8f8f8;
            border: 1px dashed #ccc;
            min-height: 50px;
        }
        
        .mermaid[data-processed] {
            background: transparent;
            border: none;
        }
        
        .mermaid-error {
            background: #ffeeee;
            padding: 10px;
            border: 1px solid #ff0000;
            color: #333;
            display: block;
            margin: 10px 0;
        }
        
        pre code.language-mermaid,
        code.language-mermaid {
            /* Don't hide code blocks - let JavaScript handle conversion */
            display: block;
            background: #f5f5f5;
            padding: 10px;
            border: 1px solid #ddd;
            font-family: monospace;
            white-space: pre;
        }
        
        /* Ensure Mermaid diagrams are visible */
        .mermaid svg {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <h1>Mermaid Test Fix</h1>
    
    <h2>Test Mermaid Diagram</h2>
    <pre><code class="language-mermaid">graph TD
    A[Christmas] -->|Get money| B(Go shopping)
    B --> C{Let me think}
    C -->|One| D[Laptop]
    C -->|Two| E[iPhone]
    C -->|Three| F[Car]</code></pre>

    <script>
        const mermaidStyle = document.createElement("style"); 
        mermaidStyle.textContent = `
            .mermaid {
                background: transparent;
                padding: 10px;
                border: none;
                font-family: monospace;
                text-align: center;
                display: block;
                margin: 10px 0;
            }
            
            .mermaid:not([data-processed]) {
                background: #f8f8f8;
                border: 1px dashed #ccc;
                min-height: 50px;
            }
            
            .mermaid[data-processed] {
                background: transparent;
                border: none;
            }
            
            .mermaid-error {
                background: #ffeeee;
                padding: 10px;
                border: 1px solid #ff0000;
                color: #333;
                display: block;
                margin: 10px 0;
            }
            
            pre code.language-mermaid,
            code.language-mermaid {
                /* Don't hide code blocks - let JavaScript handle conversion */
                display: block;
                background: #f5f5f5;
                padding: 10px;
                border: 1px solid #ddd;
                font-family: monospace;
                white-space: pre;
            }
            
            /* Ensure Mermaid diagrams are visible */
            .mermaid svg {
                max-width: 100%;
                height: auto;
            }
        `; 
        document.head.appendChild(mermaidStyle);
        
        // Debug function to show what elements we have
        function debugMermaidElements() {
            const preElements = document.querySelectorAll("pre");
            console.log("All pre elements:", preElements.length);
            
            const codeElements = document.querySelectorAll("code");
            console.log("All code elements:", codeElements.length);
            
            const mermaidCodeElements = document.querySelectorAll("code.language-mermaid");
            console.log("Mermaid code elements:", mermaidCodeElements.length);
            
            const mermaidDivElements = document.querySelectorAll("div.mermaid");
            console.log("Mermaid div elements:", mermaidDivElements.length);
            
            mermaidCodeElements.forEach(function(el, index) {
                console.log("Mermaid code element #" + index + ":", el.outerHTML);
            });
            
            mermaidDivElements.forEach(function(el, index) {
                console.log("Mermaid div element #" + index + ":", el.outerHTML);
            });
        }
        
        // Fallback function to manually convert code blocks to Mermaid diagrams
        function convertCodeToMermaid() {
            // Find code blocks with language-mermaid class
            const mermaidCodeBlocks = document.querySelectorAll("pre code.language-mermaid, code.language-mermaid");
            console.log("Found " + mermaidCodeBlocks.length + " Mermaid code blocks to convert");
            
            mermaidCodeBlocks.forEach(function(codeBlock) {
                try {
                    const content = codeBlock.textContent;
                    console.log("Converting code block to Mermaid:", content);
                    
                    // Skip if already converted
                    if (codeBlock.closest(".mermaid")) {
                        console.log("Already converted, skipping");
                        return;
                    }
                    
                    // Create a new div for the Mermaid diagram
                    const mermaidDiv = document.createElement("div");
                    mermaidDiv.className = "mermaid";
                    mermaidDiv.textContent = content;
                    
                    // Replace the pre element with the Mermaid div
                    const preElement = codeBlock.closest("pre");
                    if (preElement) {
                        preElement.parentNode.replaceChild(mermaidDiv, preElement);
                    } else {
                        codeBlock.parentNode.replaceChild(mermaidDiv, codeBlock);
                    }
                    
                    console.log("Converted code block to Mermaid div");
                } catch (e) {
                    console.error("Error converting code block to Mermaid:", e);
                }
            });
        }
        
        // Ensure mermaid is properly initialized
        function initMermaid() {
            if (typeof mermaid !== "undefined") {
                console.log("Initializing Mermaid...");
                debugMermaidElements();
                
                // First, try to convert any remaining code blocks
                convertCodeToMermaid();
                
                // Configure mermaid
                mermaid.initialize({ 
                    startOnLoad: false,
                    theme: "default",
                    securityLevel: "loose",
                    flowchart: {
                        useMaxWidth: true
                    },
                    fontFamily: "monospace",
                    logLevel: 1
                });
                
                // Add error handling
                mermaid.parseError = function(err, hash) {
                    console.error("Mermaid syntax error:", err);
                    console.error("Error hash:", hash);
                };
                
                // Check for mermaid elements
                const mermaidElements = document.querySelectorAll(".mermaid");
                console.log("Found " + mermaidElements.length + " Mermaid elements");
                
                // Process each element
                mermaidElements.forEach(function(element, index) {
                    console.log("Processing Mermaid element #" + index + ":", element.textContent);
                    
                    // Check for corrupted content
                    if (element.textContent && element.textContent.indexOf("; class Z,AA notes") !== -1) {
                        console.warn("Corrupted content detected in element #" + index);
                        element.innerHTML = "<div style=\"background:#ffeeee; padding:10px; border:1px solid #ff0000;\"><strong>Mermaid Error:</strong> Known corrupted pattern detected<br><small>Content: " + element.textContent.substring(0, 100).replace(/</g, "&lt;").replace(/>/g, "&gt;") + "</small></div>";
                        return;
                    }
                });
                
                // Render all mermaid diagrams
                if (mermaidElements.length > 0) {
                    try {
                        console.log("Rendering Mermaid diagrams...");
                        mermaid.run({
                            nodes: mermaidElements
                        }).then(() => {
                            console.log("Mermaid rendering completed successfully");
                        }).catch((error) => {
                            console.error("Mermaid rendering failed:", error);
                        });
                    } catch (error) {
                        console.error("Mermaid init error:", error);
                    }
                } else {
                    console.log("No Mermaid elements found to render");
                }
            } else {
                console.warn("Mermaid not loaded yet, retrying...");
                // Retry after a short delay
                setTimeout(initMermaid, 100);
            }
        }
        
        // Initialize when DOM is ready
        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", function() {
                // Small delay to ensure all content is loaded
                setTimeout(initMermaid, 100);
            });
        } else {
            // DOM is already ready
            setTimeout(initMermaid, 100);
        }
        
        // Also initialize after a small delay to catch any late-loading content
        setTimeout(initMermaid, 500);
        setTimeout(debugMermaidElements, 1000);
        setTimeout(convertCodeToMermaid, 1500);
        
        // Support for dynamically added content
        if (window.MutationObserver && typeof mermaid !== "undefined") {
            const observer = new MutationObserver(function(mutations) {
                let shouldReinit = false;
                mutations.forEach(function(mutation) {
                    if (mutation.type === "childList") {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1) {
                                // Check if this is a code block that needs conversion
                                if (node.tagName === "CODE" && node.classList && node.classList.contains("language-mermaid")) {
                                    console.log("New Mermaid code block detected, converting...");
                                    try {
                                        const content = node.textContent;
                                        const mermaidDiv = document.createElement("div");
                                        mermaidDiv.className = "mermaid";
                                        mermaidDiv.textContent = content;
                                        const parent = node.parentNode;
                                        if (parent) {
                                            parent.replaceChild(mermaidDiv, node);
                                        }
                                        shouldReinit = true;
                                    } catch (e) {
                                        console.error("Error converting new code block:", e);
                                    }
                                }
                                // Check if this is already a Mermaid div
                                else if (node.classList && node.classList.contains("mermaid")) {
                                    console.log("New Mermaid element detected");
                                    // Check for corrupted content before processing
                                    if (node.textContent && node.textContent.indexOf("; class Z,AA notes") !== -1) {
                                        node.innerHTML = "<div style=\"background:#ffeeee; padding:10px; border:1px solid #ff0000;\"><strong>Mermaid Error:</strong> Known corrupted pattern detected<br><small>Content: " + node.textContent.substring(0, 100).replace(/</g, "&lt;").replace(/>/g, "&gt;") + "</small></div>";
                                        return;
                                    }
                                    shouldReinit = true;
                                }
                            }
                        });
                    }
                });
                
                if (shouldReinit) {
                    setTimeout(function() {
                        try {
                            console.log("Re-initializing Mermaid for dynamic content");
                            const mermaidElements = document.querySelectorAll(".mermaid:not([data-processed])");
                            if (mermaidElements.length > 0) {
                                mermaid.run({
                                    nodes: mermaidElements
                                }).then(() => {
                                    console.log("Dynamic Mermaid rendering completed successfully");
                                }).catch((error) => {
                                    console.error("Dynamic Mermaid rendering failed:", error);
                                });
                            }
                        } catch (e) {
                            console.warn("Mermaid re-init failed:", e);
                        }
                    }, 100);
                }
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }
    </script>
</body>
</html>