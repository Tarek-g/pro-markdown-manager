<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Mermaid Test</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.4/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .mermaid {
            background: white;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            text-align: center;
            display: block;
            margin: 20px 0;
            min-height: 50px;
        }
        
        pre code.language-mermaid,
        code.language-mermaid {
            display: block;
            background: #f8f8f8;
            padding: 15px;
            border: 1px dashed #ccc;
            font-family: 'Courier New', monospace;
            white-space: pre;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .mermaid svg {
            max-width: 100%;
            height: auto;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border-left: 4px solid #0073aa;
            background: #fafafa;
        }
        
        .explanation {
            background: #e8f5fe;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            border-left: 4px solid #0073aa;
        }
        
        button {
            background: #0073aa;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        
        button:hover {
            background: #005a87;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Final Mermaid Test - Fixed Implementation</h1>
        
        <div class="explanation">
            <h3>What's Fixed:</h3>
            <ul>
                <li>Using Mermaid.js version 10.9.4 (latest stable)</li>
                <li>Improved JavaScript initialization with proper error handling</li>
                <li>Better content conversion from code blocks to Mermaid diagrams</li>
                <li>Enhanced CSS styling for proper display</li>
                <li>Added debugging capabilities</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h2>Test 1: Pre-formatted Code Block</h2>
            <p>This should be automatically converted to a Mermaid diagram.</p>
            <pre><code class="language-mermaid">graph TD
    A[Christmas] -->|Get money| B(Go shopping)
    B --> C{Let me think}
    C -->|One| D[Laptop]
    C -->|Two| E[iPhone]
    C -->|Three| F[Car]</code></pre>
        </div>
        
        <div class="test-section">
            <h2>Test 2: Inline Code Block</h2>
            <p>This should also be converted to a Mermaid diagram.</p>
            <code class="language-mermaid">graph TD
    A[Start] --> B[Process]
    B --> C[End]</code>
        </div>
        
        <div class="test-section">
            <h2>Test 3: Already Converted Div</h2>
            <p>This is already in the correct format.</p>
            <div class="mermaid">graph TD
    X[Input] --> Y[Process]
    Y --> Z[Output]</div>
        </div>
        
        <div class="test-section">
            <h2>Test 4: Sequence Diagram</h2>
            <pre><code class="language-mermaid">sequenceDiagram
    participant Alice
    participant Bob
    Alice->>John: Hello John, how are you?
    loop Healthcheck
        John->>John: Fight against hypochondria
    end
    Note right of John: Rational thoughts<br/>prevail...
    John-->>Alice: Great!
    John->>Bob: How about you?
    Bob-->>John: Jolly good!</code></pre>
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
            <button onclick="initMermaid()">Re-initialize Mermaid</button>
            <button onclick="debugMermaidElements()">Debug Elements</button>
            <button onclick="convertCodeToMermaid()">Convert Code Blocks</button>
        </div>
    </div>

    <script>
        // Configure Mermaid
        mermaid.initialize({ 
            startOnLoad: false,
            theme: "default",
            securityLevel: "loose",
            flowchart: {
                useMaxWidth: true
            },
            fontFamily: "monospace",
            logLevel: 1
        });
        
        // Debug function to show what elements we have
        function debugMermaidElements() {
            const preElements = document.querySelectorAll("pre");
            console.log("All pre elements:", preElements.length);
            
            const codeElements = document.querySelectorAll("code");
            console.log("All code elements:", codeElements.length);
            
            const mermaidCodeElements = document.querySelectorAll("code.language-mermaid");
            console.log("Mermaid code elements:", mermaidCodeElements.length);
            
            const mermaidDivElements = document.querySelectorAll("div.mermaid");
            console.log("Mermaid div elements:", mermaidDivElements.length);
            
            mermaidCodeElements.forEach(function(el, index) {
                console.log("Mermaid code element #" + index + ":", el.outerHTML);
            });
            
            mermaidDivElements.forEach(function(el, index) {
                console.log("Mermaid div element #" + index + ":", el.outerHTML);
            });
            
            alert(`Found:
- ${preElements.length} pre elements
- ${codeElements.length} code elements
- ${mermaidCodeElements.length} Mermaid code elements
- ${mermaidDivElements.length} Mermaid div elements
            
Check the browser console for details.`);
        }
        
        // Fallback function to manually convert code blocks to Mermaid diagrams
        function convertCodeToMermaid() {
            // Find code blocks with language-mermaid class
            const mermaidCodeBlocks = document.querySelectorAll("pre code.language-mermaid, code.language-mermaid");
            console.log("Found " + mermaidCodeBlocks.length + " Mermaid code blocks to convert");
            
            let convertedCount = 0;
            
            mermaidCodeBlocks.forEach(function(codeBlock) {
                try {
                    const content = codeBlock.textContent;
                    console.log("Converting code block to Mermaid:", content);
                    
                    // Skip if already converted
                    if (codeBlock.closest(".mermaid") && codeBlock.closest(".mermaid").classList.contains("mermaid")) {
                        console.log("Already converted, skipping");
                        return;
                    }
                    
                    // Create a new div for the Mermaid diagram
                    const mermaidDiv = document.createElement("div");
                    mermaidDiv.className = "mermaid";
                    mermaidDiv.textContent = content;
                    
                    // Replace the pre element with the Mermaid div
                    const preElement = codeBlock.closest("pre");
                    if (preElement) {
                        preElement.parentNode.replaceChild(mermaidDiv, preElement);
                    } else {
                        codeBlock.parentNode.replaceChild(mermaidDiv, codeBlock);
                    }
                    
                    console.log("Converted code block to Mermaid div");
                    convertedCount++;
                } catch (e) {
                    console.error("Error converting code block to Mermaid:", e);
                }
            });
            
            alert(`Converted ${convertedCount} code blocks to Mermaid diagrams. Check the console for details.`);
        }
        
        // Ensure mermaid is properly initialized
        function initMermaid() {
            if (typeof mermaid !== "undefined") {
                console.log("Initializing Mermaid...");
                debugMermaidElements();
                
                // First, try to convert any remaining code blocks
                convertCodeToMermaid();
                
                // Add error handling
                mermaid.parseError = function(err, hash) {
                    console.error("Mermaid syntax error:", err);
                    console.error("Error hash:", hash);
                    alert("Mermaid syntax error: " + err);
                };
                
                // Check for mermaid elements
                const mermaidElements = document.querySelectorAll(".mermaid");
                console.log("Found " + mermaidElements.length + " Mermaid elements");
                
                // Render all mermaid diagrams
                if (mermaidElements.length > 0) {
                    try {
                        console.log("Rendering Mermaid diagrams...");
                        mermaid.run({
                            nodes: mermaidElements
                        }).then(() => {
                            console.log("Mermaid rendering completed successfully");
                            alert("Mermaid rendering completed successfully!");
                        }).catch((error) => {
                            console.error("Mermaid rendering failed:", error);
                            alert("Mermaid rendering failed: " + error);
                        });
                    } catch (error) {
                        console.error("Mermaid init error:", error);
                        alert("Mermaid init error: " + error);
                    }
                } else {
                    console.log("No Mermaid elements found to render");
                    alert("No Mermaid elements found to render");
                }
            } else {
                console.warn("Mermaid not loaded yet");
                alert("Mermaid not loaded yet");
            }
        }
        
        // Initialize when DOM is ready
        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", function() {
                // Small delay to ensure all content is loaded
                setTimeout(initMermaid, 100);
            });
        } else {
            // DOM is already ready
            setTimeout(initMermaid, 100);
        }
        
        // Also initialize after a small delay to catch any late-loading content
        setTimeout(initMermaid, 500);
        setTimeout(debugMermaidElements, 1000);
        setTimeout(convertCodeToMermaid, 1500);
    </script>
</body>
</html>